<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>å†™çœŸã‚’æŠ•ç¨¿ | ã­ã“ãšã‹ã‚“</title>
  <link rel="stylesheet" href="../css/style.css">
</head>
<body class="post-page">

  <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ -->
  <header class="site-header">
    <div class="container header-inner">
      <a href="../index.html" class="site-logo">ğŸ± ã­ã“ãšã‹ã‚“</a>
      <nav class="header-nav">
        <a href="../index.html" class="nav-link">â† ã‚‚ã©ã‚‹</a>
      </nav>
    </div>
  </header>

  <main class="post-container">
    <div class="section-header">
      <div class="section-badge">ğŸ“¸ æŠ•ç¨¿</div>
      <h1 class="section-title">ã†ã¡ã®å­ã‚’ç´¹ä»‹ã™ã‚‹</h1>
      <p class="section-sub">ãƒ­ã‚°ã‚¤ãƒ³ä¸è¦ï¼ã‚ãªãŸã®æ„›çŒ«ã®å†™çœŸã‚’ã¿ã‚“ãªã«è¦‹ã›ã¦ã‚ã’ã‚ˆã†ï¼</p>
    </div>

    <div class="post-card-form" id="post-form-card">

      <!-- ç”»åƒã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã‚¨ãƒªã‚¢ -->
      <div class="form-group">
        <label class="form-label">å†™çœŸ <span class="required">*</span></label>
        <div class="drop-zone" id="drop-zone">
          <div class="drop-zone-content">
            <div class="drop-zone-icon">ğŸ¾</div>
            <p class="drop-zone-text">
              <strong>ã‚¯ãƒªãƒƒã‚¯ã¾ãŸã¯ãƒ‰ãƒ©ãƒƒã‚°ï¼†ãƒ‰ãƒ­ãƒƒãƒ—</strong><br>
              JPGãƒ»PNGãƒ»GIFï¼ˆ5MBä»¥å†…ï¼‰
            </p>
          </div>
          <input type="file" id="file-input" accept="image/jpeg,image/png,image/gif" aria-label="ç”»åƒã‚’é¸æŠ">
          <img id="drop-preview" class="drop-preview" alt="ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼">
        </div>
        <div class="form-error" id="img-error"></div>
      </div>

      <!-- çŒ«ã®åå‰ -->
      <div class="form-group">
        <label class="form-label" for="cat-name">çŒ«ã®åå‰ <span class="required">*</span></label>
        <input class="form-input" type="text" id="cat-name" placeholder="ä¾‹ï¼šã‚‚ãµã‚‚ãµ" required maxlength="30">
      </div>

      <!-- æŠ•ç¨¿è€…ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ  -->
      <div class="form-group">
        <label class="form-label" for="poster-name">ã‚ãªãŸã®ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ </label>
        <input class="form-input" type="text" id="poster-name" placeholder="çœç•¥ã™ã‚‹ã¨ã€Œåç„¡ã—ã•ã‚“ã€ã«ãªã‚Šã¾ã™" maxlength="20">
        <span class="form-hint">ãƒ­ã‚°ã‚¤ãƒ³ä¸è¦ãƒ»æœ¬åã§ãªãã¦OK</span>
      </div>

      <!-- ç´¹ä»‹æ–‡ -->
      <div class="form-group">
        <label class="form-label" for="cat-desc">çŒ«ã®ç´¹ä»‹æ–‡</label>
        <textarea class="form-textarea" id="cat-desc" placeholder="ã†ã¡ã®å­ã®ã‹ã‚ã„ã„ã¨ã“ã‚ã‚’æ•™ãˆã¦ã­ï¼" maxlength="200" rows="4"></textarea>
        <div class="char-count"><span id="desc-count">0</span>/200</div>
      </div>

      <!-- ã‚¿ã‚° -->
      <div class="form-group">
        <label class="form-label" for="cat-tags">ã‚¿ã‚°</label>
        <input class="form-input" type="text" id="cat-tags" placeholder="ä¾‹ï¼šèŒ¶ãƒˆãƒ© ã‚ªã‚¹ 2æ­³ï¼ˆã‚¹ãƒšãƒ¼ã‚¹åŒºåˆ‡ã‚Šï¼‰">
        <span class="form-hint"># ã‚’ã¤ã‘ãªãã¦ã‚‚OKã€‚ã‚¹ãƒšãƒ¼ã‚¹ã§åŒºåˆ‡ã‚‹ã¨è¤‡æ•°ã‚¿ã‚°ã«ãªã‚Šã¾ã™</span>
      </div>

      <!-- ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹ãƒãƒ¼ -->
      <div id="progress-wrap" style="display:none">
        <p style="font-size:0.85rem;color:var(--text-muted);margin-bottom:0.25rem">ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ä¸­...</p>
        <div class="progress-bar-wrap"><div class="progress-bar" id="progress-bar"></div></div>
      </div>

      <!-- ã‚¨ãƒ©ãƒ¼ãƒ»æŠ•ç¨¿ãƒœã‚¿ãƒ³ -->
      <div class="form-error" id="post-error"></div>
      <button class="btn btn-primary" id="submit-btn" style="justify-content:center;padding:0.9rem">
        <span class="btn-text">ğŸ“¸ æŠ•ç¨¿ã™ã‚‹</span>
      </button>
    </div>

    <!-- æˆåŠŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ -->
    <div class="success-msg" id="success-msg">
      <div class="success-emoji">ğŸ‰</div>
      <h2>æŠ•ç¨¿ã§ããŸã‚ˆï¼</h2>
      <p style="color:var(--text-muted);margin:0.5rem 0 1.5rem">ã¿ã‚“ãªãŒã‚ãªãŸã®çŒ«ã¡ã‚ƒã‚“ã‚’è¦‹ã‚‹ã®ã‚’æ¥½ã—ã¿ã«ã—ã¦ã‚‹ã‚ˆ</p>
      <a href="../index.html" class="btn btn-primary">ãƒ•ã‚£ãƒ¼ãƒ‰ã‚’è¦‹ã‚‹</a>
    </div>
  </main>

  <script type="module">
    import { uploadImage, createPost } from '../js/post.js';
    import { launchConfetti, showToast } from '../js/feed.js';

    const dropZone = document.getElementById('drop-zone');
    const fileInput = document.getElementById('file-input');
    const preview = document.getElementById('drop-preview');
    const imgError = document.getElementById('img-error');
    let selectedFile = null;

    // ãƒ‰ãƒ©ãƒƒã‚°ï¼†ãƒ‰ãƒ­ãƒƒãƒ—
    dropZone.addEventListener('dragover', e => { e.preventDefault(); dropZone.classList.add('dragover'); });
    dropZone.addEventListener('dragleave', () => dropZone.classList.remove('dragover'));
    dropZone.addEventListener('drop', e => {
      e.preventDefault();
      dropZone.classList.remove('dragover');
      const file = e.dataTransfer.files[0];
      if (file) validateAndPreview(file);
    });
    fileInput.addEventListener('change', () => {
      if (fileInput.files[0]) validateAndPreview(fileInput.files[0]);
    });

    function validateAndPreview(file) {
      imgError.classList.remove('show');
      const allowed = ['image/jpeg', 'image/png', 'image/gif'];
      if (!allowed.includes(file.type)) {
        imgError.textContent = 'JPGãƒ»PNGãƒ»GIF ã®ã¿ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã§ãã¾ã™';
        imgError.classList.add('show'); return;
      }
      if (file.size > 5 * 1024 * 1024) {
        imgError.textContent = 'ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚ºã¯5MBä»¥å†…ã«ã—ã¦ãã ã•ã„';
        imgError.classList.add('show'); return;
      }
      selectedFile = file;
      const reader = new FileReader();
      reader.onload = () => {
        preview.src = reader.result;
        dropZone.classList.add('has-preview');
      };
      reader.readAsDataURL(file);
    }

    // æ–‡å­—ã‚«ã‚¦ãƒ³ãƒˆ
    const descEl = document.getElementById('cat-desc');
    descEl.addEventListener('input', () => {
      document.getElementById('desc-count').textContent = descEl.value.length;
    });

    // æŠ•ç¨¿é€ä¿¡
    document.getElementById('submit-btn').addEventListener('click', async () => {
      const catName = document.getElementById('cat-name').value.trim();
      const posterName = document.getElementById('poster-name').value.trim();
      const desc = descEl.value.trim();
      const tagsRaw = document.getElementById('cat-tags').value.trim();
      const postError = document.getElementById('post-error');
      postError.classList.remove('show');

      if (!selectedFile) {
        imgError.textContent = 'å†™çœŸã‚’é¸ã‚“ã§ãã ã•ã„';
        imgError.classList.add('show'); return;
      }
      if (!catName) {
        postError.textContent = 'çŒ«ã®åå‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„';
        postError.classList.add('show'); return;
      }

      const tags = tagsRaw
        ? tagsRaw.split(/\s+/).filter(Boolean).map(t => t.startsWith('#') ? t : '#' + t)
        : [];

      const btn = document.getElementById('submit-btn');
      btn.disabled = true;
      btn.innerHTML = '<span class="spinner"></span> æŠ•ç¨¿ä¸­...';

      const progressWrap = document.getElementById('progress-wrap');
      const progressBar = document.getElementById('progress-bar');
      progressWrap.style.display = 'block';
      let prog = 0;
      const progInterval = setInterval(() => {
        prog = Math.min(prog + Math.random() * 15, 85);
        progressBar.style.width = prog + '%';
      }, 200);

      try {
        const imageUrl = await uploadImage(selectedFile);
        clearInterval(progInterval);
        progressBar.style.width = '100%';

        await createPost({ imageUrl, catName, posterName, description: desc, tags });

        setTimeout(() => {
          document.getElementById('post-form-card').style.display = 'none';
          document.getElementById('success-msg').classList.add('show');
          launchConfetti();
        }, 400);
      } catch (err) {
        clearInterval(progInterval);
        progressWrap.style.display = 'none';
        progressBar.style.width = '0%';
        postError.textContent = 'ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸï¼š' + (err.message || err);
        postError.classList.add('show');
        btn.disabled = false;
        btn.innerHTML = '<span class="btn-text">ğŸ“¸ æŠ•ç¨¿ã™ã‚‹</span>';
      }
    });
  </script>
</body>
</html>
